<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Anggota ASDI</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="dashboard-page">

<header class="dashboard-header">
  <div class="logo-bg">
    <img src="images/Logo-ASDI.png" alt="Logo ASDI" class="logo-small">
  </div>
  <div class="header-text">
    <h1>Dashboard Anggota ASDI</h1>
    <p>Korwil Madiun</p>
  </div>
</header>

<main class="dashboard-center">
  <div class="id-card-modern">
    <div class="card-header-modern">
      <img src="images/logo_korwilMadiun.png" alt="Logo ASDI" class="logo-asdi">
      <div class="org-info">
        <h3>Asosiasi Dietisien Indonesia</h3>
        <p>Korwil Madiun</p>
      </div>
    </div>
    <div class="card-body-modern">
      <div class="photo-box">
        <img id="foto" src="" alt="Foto Anggota" class="profile-photo">
      </div>
      <div class="info-box">
        <h2 id="nama"></h2>
        <p><strong>No. Anggota</strong>: <span id="nomor"></span></p>
        <p><strong>Instansi</strong>: <span id="instansi"></span></p>
        <p><strong>Wilayah</strong>: <span id="wilayah"></span></p>
      </div>
    </div>
  </div>

  <button id="logoutBtn">Keluar</button>
  <button id="downloadKtaBtn">Download KTA</button>
</main>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script type="module">
  const data = JSON.parse(sessionStorage.getItem("userData"));
  if (!data) window.location.href = "index.html";

  document.getElementById("nama").innerText = data.nama;
  document.getElementById("nomor").innerText = data.nomor_anggota;
  document.getElementById("instansi").innerText = data.instansi;
  document.getElementById("wilayah").innerText = data.wilayah;
  document.getElementById("foto").src = data.foto?.trim();

  document.getElementById("logoutBtn").addEventListener("click", () => {
    sessionStorage.clear();
    window.location.href = "index.html";
  });

  document.getElementById("downloadKtaBtn").addEventListener("click", async () => {
    const card = document.querySelector(".id-card-modern");
    const btn = document.getElementById("downloadKtaBtn");
    btn.disabled = true;
    btn.textContent = "Menyimpan...";

    const originalSrc = document.getElementById("foto").src;
    const proxyUrl = `https://kta-website-49yl.vercel.app/api/proxy?url=${encodeURIComponent(data.foto)}`;

    const fotoEl = document.getElementById("foto");
    fotoEl.src = proxyUrl;

    fotoEl.onload = async () => {
      try {
        const canvas = await html2canvas(card, { scale: 3, useCORS: true });
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `${data.nama.replace(/\s+/g,"_")}_KTA_ASDI.png`;
        link.click();

        fotoEl.src = originalSrc;
        btn.disabled = false;
        btn.textContent = "Download KTA";
      } catch (err) {
        console.error(err);
        alert("Gagal membuat KTA");
        fotoEl.src = originalSrc;
        btn.disabled = false;
        btn.textContent = "Download KTA";
      }
    };

    fotoEl.onerror = () => {
      alert("Gagal memuat foto untuk download");
      fotoEl.src = originalSrc;
      btn.disabled = false;
      btn.textContent = "Download KTA";
    };
  });
</script>

</body>
</html>
